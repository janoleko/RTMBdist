<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Examples • RTMBdist</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Examples">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RTMBdist</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/distlist.html">List of distributions</a></li>
    <li><a class="dropdown-item" href="../articles/Examples.html">Examples</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Examples</h1>
            
      

      <div class="d-none name"><code>Examples.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://janoleko.github.io/RTMBdist/">RTMBdist</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="example-1-chicken-weight">Example 1: Chicken weight<a class="anchor" aria-label="anchor" href="#example-1-chicken-weight"></a>
</h2>
<p>Our first example is the chicken weight data set, already used in the
<code>RTMB</code> Introduction vignette.</p>
<p>We fit the same random regression model, where each chick has its own
intercept and slope parameters that are assumed to be normally
distributed. However, instead of assuming normal errors, we assume that
the observations given the time and chick follow a Box-Cox Cole-Green
(BCCG) distribution, which allows for skewness in the data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">ChickWeight</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  mua<span class="op">=</span><span class="fl">0</span>,          <span class="co">## Mean slope</span></span>
<span>  log_sda<span class="op">=</span><span class="fl">1</span>,      <span class="co">## log-Std of slopes</span></span>
<span>  mub<span class="op">=</span><span class="fl">0</span>,          <span class="co">## Mean intercept</span></span>
<span>  log_sdb<span class="op">=</span><span class="fl">1</span>,      <span class="co">## log-Std of intercepts</span></span>
<span>  log_sigma<span class="op">=</span><span class="fl">0</span>,    <span class="co">## log-Scale of BCCG distribution</span></span>
<span>  nu <span class="op">=</span> <span class="fl">0.1</span>,       <span class="co">## Skewness of BCCG distribution</span></span>
<span>  a<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span>,   <span class="co">## Random slope by chick</span></span>
<span>  b<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">50</span><span class="op">)</span>    <span class="co">## Random intercept by chick</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The joint negative log-likelihood function has the same structure as
in the <code>RTMB</code> vignette, but with the normal likelihood
replaced by the BCCG likelihood, and hence also some necessary parameter
transformations.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nll</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">parms</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">getAll</a></span><span class="op">(</span><span class="va">ChickWeight</span>, <span class="va">parms</span>, warn<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="co">## Optional (enables extra RTMB features)</span></span>
<span>  <span class="va">weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">OBS</a></span><span class="op">(</span><span class="va">weight</span><span class="op">)</span></span>
<span>  <span class="co">## Initialize joint negative log likelihood</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="co">## Random slopes</span></span>
<span>  <span class="va">sda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_sda</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">sda</span><span class="op">)</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">a</span>, mean<span class="op">=</span><span class="va">mua</span>, sd<span class="op">=</span><span class="va">sda</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">## Random intercepts</span></span>
<span>  <span class="va">sdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_sdb</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">sdb</span><span class="op">)</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">b</span>, mean<span class="op">=</span><span class="va">mub</span>, sd<span class="op">=</span><span class="va">sdb</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">## Data</span></span>
<span>  <span class="va">predWeight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">a</span><span class="op">[</span><span class="va">Chick</span><span class="op">]</span> <span class="op">*</span> <span class="va">Time</span> <span class="op">+</span> <span class="va">b</span><span class="op">[</span><span class="va">Chick</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_sigma</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/bccg.html">dbccg</a></span><span class="op">(</span><span class="va">weight</span>, mu<span class="op">=</span><span class="va">predWeight</span>, sigma<span class="op">=</span><span class="va">sigma</span>, nu<span class="op">=</span><span class="va">nu</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">## Get predicted weight uncertainties</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">predWeight</span><span class="op">)</span></span>
<span>  <span class="co">## Return</span></span>
<span>  <span class="va">nll</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The model can then again be fitted by constructing the
Laplace-approximated marginal log-likelihood function and optimising
this using any standard numerical optimiser.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">MakeADFun</span><span class="op">(</span><span class="va">nll</span>, <span class="va">parameters</span>, random<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">par</span>, <span class="va">obj</span><span class="op">$</span><span class="va">fn</span>, <span class="va">obj</span><span class="op">$</span><span class="va">gr</span><span class="op">)</span></span></code></pre></div>
<p>We can use <code>RTMB</code>’s automatic simulation capabilities to
simulate from the fitted model and run a check whether the Laplace
approximation is adequate. All of this is done by a simple call to
<code><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">checkConsistency()</a></code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">chk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">checkConsistency</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<span><span class="va">chk</span></span>
<span><span class="co">#&gt; Parameters used for simulation:</span></span>
<span><span class="co">#&gt;         mua     log_sda         mub     log_sdb   log_sigma          nu </span></span>
<span><span class="co">#&gt;  0.07799513 -3.86869405  3.80355961 -2.65747574 -2.32420504  3.44873713 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Test correct simulation (p.value):</span></span>
<span><span class="co">#&gt; [1] 0.7383633</span></span>
<span><span class="co">#&gt; Simulation appears to be correct</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimated parameter bias:</span></span>
<span><span class="co">#&gt;           mua       log_sda           mub       log_sdb     log_sigma </span></span>
<span><span class="co">#&gt; -0.0001346800  0.0064958230 -0.0001147128 -0.0147141495  0.0042912804 </span></span>
<span><span class="co">#&gt;            nu </span></span>
<span><span class="co">#&gt; -0.0836398603</span></span></code></pre></div>
<p>Lastly, we can also automatically calculate quantile residuals via
probability integral transform using <code><a href="https://rdrr.io/pkg/RTMB/man/OSA-residuals.html" class="external-link">oneStepPredict()</a></code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">osa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/OSA-residuals.html" class="external-link">oneStepPredict</a></span><span class="op">(</span><span class="va">obj</span>, discrete<span class="op">=</span><span class="cn">FALSE</span>, trace<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">osa</span><span class="op">$</span><span class="va">res</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="Examples_files/figure-html/residuals-1.png" width="700"></p>
<p>We see that this model is still not suitable but a bit better than
the Gaussian model in the <code>RTMB</code> vignette.</p>
</div>
<div class="section level2">
<h2 id="example-2-distributional-regression-with-penalised-splines">Example 2: Distributional regression with penalised splines<a class="anchor" aria-label="anchor" href="#example-2-distributional-regression-with-penalised-splines"></a>
</h2>
<p>Our second example will cover the famous dutch boys BMI data set,
which is part of the <code>gamlss.data</code> package. We will fit a
distributional regression model where the location, scale, and skewness
parameters of the Box-Cox power exponential (BCPE) distribution are
modelled as smooth functions of age using penalised splines. The
kurtosis parameter will be kept constant.</p>
<p>We start by loading packages that are needed.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.gamlss.com/" class="external-link">gamlss.data</a></span><span class="op">)</span>   <span class="co"># contains dutch-boys data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://janoleko.github.io/LaMa/" class="external-link">LaMa</a></span><span class="op">)</span>          <span class="co"># for creating model matrices</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span>        <span class="co"># to create sparse matrices</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">dbbmi</span><span class="op">)</span></span></code></pre></div>
<p>We will use the function <code><a href="https://janoleko.github.io/reference/make_matrices.html" class="external-link">make_matrices()</a></code> from package
<code>LaMa</code> to conveniently create design and penalty matrices for
the smooth functions. The penalty matrix is converted to a sparse matrix
using the <code>Matrix</code> package, to work with <code>RTMB</code>’s
<code><a href="https://rdrr.io/pkg/RTMB/man/MVgauss.html" class="external-link">dgmrf()</a></code> function.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># basis dimension</span></span>
<span><span class="va">modmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://janoleko.github.io/reference/make_matrices.html" class="external-link">make_matrices</a></span><span class="op">(</span><span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">age</span>, bs<span class="op">=</span><span class="st">"cs"</span>, k<span class="op">=</span><span class="va">k</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dbbmi</span><span class="op">)</span> </span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">modmat</span><span class="op">$</span><span class="va">Z</span>                              <span class="co"># design matrix</span></span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Matrix.html" class="external-link">Matrix</a></span><span class="op">(</span><span class="va">modmat</span><span class="op">$</span><span class="va">S</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, sparse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>  <span class="co"># sparse penalty matrix</span></span></code></pre></div>
<p>The joint negative log-likelihood function computes covariate
dependent location, scale, and skewness parameters using the design
matrix and regression coefficients. The regression coefficients are
treated as random effects with a multivariate normal distribution with
zero mean and a precision matrix that is a scaled version of the penalty
matrix, which is achieved by calling <code><a href="https://rdrr.io/pkg/RTMB/man/MVgauss.html" class="external-link">dgmrf()</a></code> for each of
them. The scaling parameters (smoothing parameters) are estimated by
restricted maximum likelihood (REML), which is achieved by treating them
as fixed effects and integrating out the regression coefficients and
other fixed effects using the Laplace approximation.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nll2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="st">"c"</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/ADoverload.html" class="external-link">ADoverload</a></span><span class="op">(</span><span class="st">"c"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">getAll</a></span><span class="op">(</span><span class="va">par</span>, <span class="va">dat</span>, warn<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="co">## Optional (enables extra RTMB features)</span></span>
<span>  <span class="va">bmi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">OBS</a></span><span class="op">(</span><span class="va">bmi</span><span class="op">)</span></span>
<span>  <span class="co">## Calculating parameters</span></span>
<span>  <span class="va">beta_mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">beta0_mu</span>, <span class="va">beta_age_mu</span><span class="op">)</span></span>
<span>  <span class="va">beta_sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">beta0_sigma</span>, <span class="va">beta_age_sigma</span><span class="op">)</span></span>
<span>  <span class="va">beta_nu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">beta0_nu</span>, <span class="va">beta_age_nu</span><span class="op">)</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta_mu</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span> <span class="co"># location</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta_sigma</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span> <span class="co"># scale</span></span>
<span>  <span class="va">nu</span> <span class="op">&lt;-</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta_nu</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">nu</span><span class="op">)</span> <span class="co"># skewness</span></span>
<span>  <span class="va">tau</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_tau</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">tau</span><span class="op">)</span> <span class="co"># kurtosis</span></span>
<span>  <span class="co">## Likelihood: Box-Cox power exponential distribution</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/bcpe.html">dbcpe</a></span><span class="op">(</span><span class="va">bmi</span>, <span class="va">mu</span>, <span class="va">sigma</span>, <span class="va">nu</span>, <span class="va">tau</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">## Penalised splines as random effects</span></span>
<span>  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_lambda</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">REPORT</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/MVgauss.html" class="external-link">dgmrf</a></span><span class="op">(</span><span class="va">beta_age_mu</span>, <span class="fl">0</span>, <span class="va">lambda</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">S</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/MVgauss.html" class="external-link">dgmrf</a></span><span class="op">(</span><span class="va">beta_age_sigma</span>, <span class="fl">0</span>, <span class="va">lambda</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">S</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/MVgauss.html" class="external-link">dgmrf</a></span><span class="op">(</span><span class="va">beta_age_nu</span>, <span class="fl">0</span>, <span class="va">lambda</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="va">S</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">nll</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  beta0_mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">18</span><span class="op">)</span>,</span>
<span>  beta0_sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.15</span><span class="op">)</span>,</span>
<span>  beta0_nu <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>  beta_age_mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">k</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  beta_age_sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">k</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  beta_age_nu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">k</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  log_tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  log_lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1e4</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  bmi <span class="op">=</span> <span class="va">dbbmi</span><span class="op">$</span><span class="va">bmi</span>,</span>
<span>  age <span class="op">=</span> <span class="va">dbbmi</span><span class="op">$</span><span class="va">age</span>,</span>
<span>  X <span class="op">=</span> <span class="va">X</span>,</span>
<span>  S <span class="op">=</span> <span class="va">S</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>As we are using REML, we are integrating out all parameters other
than the smoothing parameters <code>log_lambda</code>, which are treated
as fixed effects. The model is then fitted by constructing the
Laplace-approximated marginal log-likelihood function and optimising
this using any standard numerical optimiser.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Restricted maximum likelihood (REML) - also integrating out fixed effects</span></span>
<span><span class="va">random</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"log_lambda"</span><span class="op">]</span></span>
<span><span class="va">obj2</span> <span class="op">&lt;-</span> <span class="fu">MakeADFun</span><span class="op">(</span><span class="va">nll2</span>, <span class="va">par</span>, random <span class="op">=</span> <span class="va">random</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">opt2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">obj2</span><span class="op">$</span><span class="va">par</span>, <span class="va">obj2</span><span class="op">$</span><span class="va">fn</span>, <span class="va">obj2</span><span class="op">$</span><span class="va">gr</span><span class="op">)</span></span></code></pre></div>
<p>We can have access to all <code><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT()</a></code>ed quantities and
their standard deviation using <code>sdreport()</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sdr</span> <span class="op">&lt;-</span> <span class="fu">sdreport</span><span class="op">(</span><span class="va">obj2</span>, ignore.parm.uncertainty <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">sdr</span>, <span class="st">"Est"</span>, report <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">par_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">sdr</span>, <span class="st">"Std"</span>, report <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>This way, we can easily plot the estimated smooth functions with
confidence intervals and the conditional distribution of BMI given
age.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">age</span> <span class="op">&lt;-</span> <span class="va">dbbmi</span><span class="op">$</span><span class="va">age</span></span>
<span><span class="va">ord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Plotting estimated effects</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="va">par</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, bty <span class="op">=</span> <span class="st">"n"</span>, xlab <span class="op">=</span> <span class="st">"Age"</span>, ylab <span class="op">=</span> <span class="st">"Mu"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html" class="external-link">polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">par_sd</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2</span><span class="op">*</span><span class="va">par_sd</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"#00000020"</span>, border <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="va">par</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, bty <span class="op">=</span> <span class="st">"n"</span>, xlab <span class="op">=</span> <span class="st">"Age"</span>, ylab <span class="op">=</span> <span class="st">"Sigma"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html" class="external-link">polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">par_sd</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2</span><span class="op">*</span><span class="va">par_sd</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"#00000020"</span>, border <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="va">par</span><span class="op">$</span><span class="va">nu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, bty <span class="op">=</span> <span class="st">"n"</span>, xlab <span class="op">=</span> <span class="st">"Age"</span>, ylab <span class="op">=</span> <span class="st">"Nu"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html" class="external-link">polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">nu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">par_sd</span><span class="op">$</span><span class="va">nu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">nu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2</span><span class="op">*</span><span class="va">par_sd</span><span class="op">$</span><span class="va">nu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"#00000020"</span>, border <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Examples_files/figure-html/effects_plot-1.png" width="700"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Plotting conditional distribution</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dbbmi</span><span class="op">$</span><span class="va">age</span>, <span class="va">dbbmi</span><span class="op">$</span><span class="va">bmi</span>, pch <span class="op">=</span> <span class="fl">16</span>, col <span class="op">=</span> <span class="st">"#00000020"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Age"</span>, ylab <span class="op">=</span> <span class="st">"BMI"</span>, bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="va">par</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"deepskyblue"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># compute quantiles (point estimates)</span></span>
<span><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">par</span>, <span class="va">as.numeric</span><span class="op">)</span></span>
<span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">ps</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.005</span> <span class="co"># avoid 0 and 1</span></span>
<span><span class="va">ps</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.995</span> <span class="co"># avoid 0 and 1</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">ps</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcpe.html">qbcpe</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">par</span><span class="op">$</span><span class="va">mu</span>, <span class="va">par</span><span class="op">$</span><span class="va">sigma</span>, <span class="va">par</span><span class="op">$</span><span class="va">nu</span>, <span class="va">par</span><span class="op">$</span><span class="va">tau</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="va">q</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"deepskyblue"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, lwd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"deepskyblue"</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Mean"</span>, <span class="st">"Quantiles"</span><span class="op">)</span>, bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Examples_files/figure-html/cond_dist-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jan-Ole Koslik.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
