<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Worked Examples • RTMBdist</title>
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Worked Examples">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RTMBdist</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/distlist.html">List of distributions</a></li>
    <li><a class="dropdown-item" href="../articles/Examples.html">Worked Examples</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Worked Examples</h1>
            
      

      <div class="d-none name"><code>Examples.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://janoleko.github.io/RTMBdist/">RTMBdist</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="example-1-random-regression-with-non-gaussian-data">Example 1: Random regression with non-Gaussian data<a class="anchor" aria-label="anchor" href="#example-1-random-regression-with-non-gaussian-data"></a>
</h2>
<p>Our first example is the chicken weight data set, already used in the
<code>RTMB</code> Introduction vignette.</p>
<p>We fit the same random regression model, where each chick has its own
intercept and slope parameters that are assumed to be normally
distributed. However, instead of assuming normal errors, we assume that
the observations given the time and chick follow a Box-Cox Cole-Green
(BCCG) distribution, which allows for skewness in the data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">ChickWeight</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  mua<span class="op">=</span><span class="fl">0</span>,          <span class="co"># Mean slope</span></span>
<span>  log_sda<span class="op">=</span><span class="fl">1</span>,      <span class="co"># log-Std of slopes</span></span>
<span>  mub<span class="op">=</span><span class="fl">0</span>,          <span class="co"># Mean intercept</span></span>
<span>  log_sdb<span class="op">=</span><span class="fl">1</span>,      <span class="co"># log-Std of intercepts</span></span>
<span>  log_sigma<span class="op">=</span><span class="fl">0</span>,    <span class="co"># log-Scale of BCCG distribution</span></span>
<span>  nu <span class="op">=</span> <span class="fl">0.1</span>,       <span class="co"># Skewness of BCCG distribution</span></span>
<span>  a<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span>,   <span class="co"># Random slope by chick</span></span>
<span>  b<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">50</span><span class="op">)</span>    <span class="co"># Random intercept by chick</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The joint negative log-likelihood function has the same structure as
in the <code>RTMB</code> vignette, but with the normal likelihood
replaced by the BCCG likelihood, and hence also some necessary parameter
transformations.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nll_chick</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">parms</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">getAll</a></span><span class="op">(</span><span class="va">ChickWeight</span>, <span class="va">parms</span>, warn<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="co"># Optional (enables extra RTMB features)</span></span>
<span>  <span class="va">weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">OBS</a></span><span class="op">(</span><span class="va">weight</span><span class="op">)</span></span>
<span>  <span class="co"># Initialise joint negative log likelihood</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="co"># Random slopes</span></span>
<span>  <span class="va">sda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_sda</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">sda</span><span class="op">)</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">a</span>, mean<span class="op">=</span><span class="va">mua</span>, sd<span class="op">=</span><span class="va">sda</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Random intercepts</span></span>
<span>  <span class="va">sdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_sdb</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">sdb</span><span class="op">)</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">b</span>, mean<span class="op">=</span><span class="va">mub</span>, sd<span class="op">=</span><span class="va">sdb</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Data</span></span>
<span>  <span class="va">predWeight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">a</span><span class="op">[</span><span class="va">Chick</span><span class="op">]</span> <span class="op">*</span> <span class="va">Time</span> <span class="op">+</span> <span class="va">b</span><span class="op">[</span><span class="va">Chick</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_sigma</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/bccg.html">dbccg</a></span><span class="op">(</span><span class="va">weight</span>, mu<span class="op">=</span><span class="va">predWeight</span>, sigma<span class="op">=</span><span class="va">sigma</span>, nu<span class="op">=</span><span class="va">nu</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Get predicted weight uncertainties</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">predWeight</span><span class="op">)</span></span>
<span>  <span class="co"># Return</span></span>
<span>  <span class="va">nll</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The model can then again be fitted by constructing the
Laplace-approximated marginal log-likelihood function and optimising
this using any standard numerical optimiser.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj_chick</span> <span class="op">&lt;-</span> <span class="fu">MakeADFun</span><span class="op">(</span><span class="va">nll_chick</span>, <span class="va">parameters</span>, random<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">opt_chick</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">obj_chick</span><span class="op">$</span><span class="va">par</span>, <span class="va">obj_chick</span><span class="op">$</span><span class="va">fn</span>, <span class="va">obj_chick</span><span class="op">$</span><span class="va">gr</span><span class="op">)</span></span></code></pre></div>
<p>We can use <code>RTMB</code>’s automatic simulation capabilities to
simulate from the fitted model and run a check whether the Laplace
approximation is adequate. All of this is done by a simple call to
<code><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">checkConsistency()</a></code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">checkConsistency</a></span><span class="op">(</span><span class="va">obj_chick</span><span class="op">)</span></span>
<span><span class="co">#&gt; Parameters used for simulation:</span></span>
<span><span class="co">#&gt;         mua     log_sda         mub     log_sdb   log_sigma          nu </span></span>
<span><span class="co">#&gt;  0.07799513 -3.86869405  3.80355961 -2.65747574 -2.32420504  3.44873713 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Test correct simulation (p.value):</span></span>
<span><span class="co">#&gt; [1] 0.7383633</span></span>
<span><span class="co">#&gt; Simulation appears to be correct</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimated parameter bias:</span></span>
<span><span class="co">#&gt;           mua       log_sda           mub       log_sdb     log_sigma </span></span>
<span><span class="co">#&gt; -0.0001346800  0.0064958230 -0.0001147128 -0.0147141495  0.0042912804 </span></span>
<span><span class="co">#&gt;            nu </span></span>
<span><span class="co">#&gt; -0.0836398603</span></span></code></pre></div>
<p>Lastly, we can also automatically calculate quantile residuals via
probability integral transform using <code><a href="https://rdrr.io/pkg/RTMB/man/OSA-residuals.html" class="external-link">oneStepPredict()</a></code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">osa_chick</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/OSA-residuals.html" class="external-link">oneStepPredict</a></span><span class="op">(</span><span class="va">obj_chick</span>, discrete<span class="op">=</span><span class="cn">FALSE</span>, trace<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">osa_chick</span><span class="op">$</span><span class="va">res</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="Examples_files/figure-html/residuals-1.png" class="r-plt" alt="" width="700"></p>
<p>We see that this model is still not a great fit but a bit better than
the Gaussian model.</p>
</div>
<div class="section level2">
<h2 id="example-2-non-standard-random-glm-for-count-data">Example 2: Non-standard random GLM for count data<a class="anchor" aria-label="anchor" href="#example-2-non-standard-random-glm-for-count-data"></a>
</h2>
<p>Our second example is the <code>InsectSprays</code> data set. We will
fit a GLMM where the counts are assumed to follow a <em>generalised</em>
Poisson distribution, allowing for overdispersion (compared to the
standard Poisson distribution). In the model, we simple include a random
effect for each spray type, to account for the fact that some sprays are
more effective than others.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">InsectSprays</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Creating the model matrix</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">spray</span> <span class="op">-</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">InsectSprays</span><span class="op">)</span></span>
<span></span>
<span><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  beta0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">InsectSprays</span><span class="op">$</span><span class="va">count</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">InsectSprays</span><span class="op">$</span><span class="va">spray</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  log_phi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  log_sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  count <span class="op">=</span> <span class="va">InsectSprays</span><span class="op">$</span><span class="va">count</span>,</span>
<span>  spray <span class="op">=</span> <span class="va">InsectSprays</span><span class="op">$</span><span class="va">spray</span>,</span>
<span>  X <span class="op">=</span> <span class="va">X</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nll_insect</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">getAll</a></span><span class="op">(</span><span class="va">par</span>, <span class="va">dat</span>, warn<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">OBS</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span></span>
<span>  <span class="co"># Random effect likelihood</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_sigma</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">beta</span>, <span class="fl">0</span>, <span class="va">sigma</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Data likelihood</span></span>
<span>  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">beta0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta</span><span class="op">)</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span></span>
<span>  <span class="va">phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_phi</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">phi</span><span class="op">)</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/genpois.html">dgenpois</a></span><span class="op">(</span><span class="va">count</span>, <span class="va">lambda</span>, <span class="va">phi</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">nll</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj_insect</span> <span class="op">&lt;-</span> <span class="fu">MakeADFun</span><span class="op">(</span><span class="va">nll_insect</span>, <span class="va">par</span>, random <span class="op">=</span> <span class="st">"beta"</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">opt_insect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">obj_insect</span><span class="op">$</span><span class="va">par</span>, <span class="va">obj_insect</span><span class="op">$</span><span class="va">fn</span>, <span class="va">obj_insect</span><span class="op">$</span><span class="va">gr</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Checking if the Laplace approximation is adequate</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">checkConsistency</a></span><span class="op">(</span><span class="va">obj_insect</span><span class="op">)</span></span>
<span><span class="co">#&gt; Parameters used for simulation:</span></span>
<span><span class="co">#&gt;      beta0    log_phi  log_sigma </span></span>
<span><span class="co">#&gt;  1.9751913 -3.8913794 -0.2221668 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Test correct simulation (p.value):</span></span>
<span><span class="co">#&gt; [1] 0.605786</span></span>
<span><span class="co">#&gt; Simulation appears to be correct</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimated parameter bias:</span></span>
<span><span class="co">#&gt;       beta0     log_phi   log_sigma </span></span>
<span><span class="co">#&gt; -0.01672544  0.03395053 -0.00437216</span></span>
<span><span class="co"># Check okay</span></span>
<span></span>
<span><span class="co"># Calculating quantile residuals</span></span>
<span><span class="va">osa_insect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/OSA-residuals.html" class="external-link">oneStepPredict</a></span><span class="op">(</span><span class="va">obj_insect</span>, method <span class="op">=</span> <span class="st">"oneStepGeneric"</span>, </span>
<span>                             discrete<span class="op">=</span><span class="cn">TRUE</span>, trace<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">osa_insect</span><span class="op">$</span><span class="va">res</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="Examples_files/figure-html/model%20fit3-1.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level2">
<h2 id="example-3-distributional-regression-with-penalised-splines">Example 3: Distributional regression with penalised splines<a class="anchor" aria-label="anchor" href="#example-3-distributional-regression-with-penalised-splines"></a>
</h2>
<p>Our third example covers the dutch boys BMI data set, part of the
<code>gamlss.data</code> package. We will fit a distributional
regression model where the location, scale, and skewness parameters of
the Box-Cox power exponential (BCPE) distribution are modelled as smooth
functions of age using penalised splines. The kurtosis parameter will be
kept constant.</p>
<p>We start by loading packages that are needed.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.gamlss.com/" class="external-link">gamlss.data</a></span><span class="op">)</span>   <span class="co"># Data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://janoleko.github.io/LaMa/" class="external-link">LaMa</a></span><span class="op">)</span>          <span class="co"># Creating model matrices</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span>        <span class="co"># Sparse matrices</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">dbbmi</span><span class="op">)</span></span>
<span><span class="co"># Subset (just for speed here)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dbbmi</span><span class="op">)</span>, <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="va">dbbmi</span> <span class="op">&lt;-</span> <span class="va">dbbmi</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span></span></code></pre></div>
<p>We use the function <code><a href="https://janoleko.github.io/reference/make_matrices.html" class="external-link">make_matrices()</a></code> from package
<code>LaMa</code> to conveniently create design and penalty matrices for
the smooth functions. Internally, this just interfaces
<code>mgcv</code>. The penalty matrix is converted to a sparse matrix
using the <code>Matrix</code> package, to work with <code>RTMB</code>’s
<code><a href="https://rdrr.io/pkg/RTMB/man/MVgauss.html" class="external-link">dgmrf()</a></code> function.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># Basis dimension</span></span>
<span><span class="va">modmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://janoleko.github.io/reference/make_matrices.html" class="external-link">make_matrices</a></span><span class="op">(</span><span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">age</span>, bs<span class="op">=</span><span class="st">"cs"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dbbmi</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">modmat</span><span class="op">$</span><span class="va">Z</span>                              <span class="co"># Design matrix</span></span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Matrix.html" class="external-link">Matrix</a></span><span class="op">(</span><span class="va">modmat</span><span class="op">$</span><span class="va">S</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, sparse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>  <span class="co"># Sparse penalty matrix</span></span></code></pre></div>
<p>The joint negative log-likelihood function computes covariate
dependent location, scale, and skewness parameters using the design
matrix and regression coefficients. The regression coefficients are
treated as random effects with a multivariate normal distribution with
zero mean and a precision matrix that is a scaled version of the penalty
matrix, which is achieved by calling <code><a href="https://rdrr.io/pkg/RTMB/man/MVgauss.html" class="external-link">dgmrf()</a></code> for each of
them. The scaling/ smoothing parameters are estimated by <em>restricted
maximum likelihood</em> (REML), which is achieved by treating them as
fixed effects and integrating out the regression coefficients and other
fixed effects using the Laplace approximation.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nll_dbbmi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">getAll</a></span><span class="op">(</span><span class="va">par</span>, <span class="va">dat</span>, warn<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">bmi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">OBS</a></span><span class="op">(</span><span class="va">bmi</span><span class="op">)</span></span>
<span>  <span class="co"># Calculating response parameters</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">beta0_mu</span>, <span class="va">beta_age_mu</span><span class="op">)</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span> <span class="co"># Location</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">beta0_sigma</span>, <span class="va">beta_age_sigma</span><span class="op">)</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span> <span class="co"># Scale</span></span>
<span>  <span class="va">nu</span> <span class="op">&lt;-</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">beta0_nu</span>, <span class="va">beta_age_nu</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">nu</span><span class="op">)</span> <span class="co"># Skewness</span></span>
<span>  <span class="va">tau</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_tau</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">tau</span><span class="op">)</span> <span class="co"># Kurtosis</span></span>
<span>  <span class="co"># Data likelihood: Box-Cox power exponential distribution</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/bcpe.html">dbcpe</a></span><span class="op">(</span><span class="va">bmi</span>, <span class="va">mu</span>, <span class="va">sigma</span>, <span class="va">nu</span>, <span class="va">tau</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Penalised splines as random effects: log likelihood / penalty</span></span>
<span>  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_lambda</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">REPORT</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/MVgauss.html" class="external-link">dgmrf</a></span><span class="op">(</span><span class="va">beta_age_mu</span>, <span class="fl">0</span>, <span class="va">lambda</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">S</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/MVgauss.html" class="external-link">dgmrf</a></span><span class="op">(</span><span class="va">beta_age_sigma</span>, <span class="fl">0</span>, <span class="va">lambda</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">S</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/MVgauss.html" class="external-link">dgmrf</a></span><span class="op">(</span><span class="va">beta_age_nu</span>, <span class="fl">0</span>, <span class="va">lambda</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="va">S</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">nll</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  beta0_mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">18</span><span class="op">)</span>, beta0_sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.15</span><span class="op">)</span>,</span>
<span>  beta0_nu <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, beta_age_mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">k</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  beta_age_sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">k</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>, beta_age_nu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">k</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  log_tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  log_lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1e4</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  bmi <span class="op">=</span> <span class="va">dbbmi</span><span class="op">$</span><span class="va">bmi</span>,</span>
<span>  age <span class="op">=</span> <span class="va">dbbmi</span><span class="op">$</span><span class="va">age</span>,</span>
<span>  X <span class="op">=</span> <span class="va">X</span>,</span>
<span>  S <span class="op">=</span> <span class="va">S</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>As we are using REML, we are integrating out <em>all</em> parameters
that are not smoothing parameters <code>log_lambda</code>. The model is
then fitted by constructing the Laplace-approximated restricted
log-likelihood function and optimising this.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Restricted maximum likelihood (REML) - also integrating out fixed effects</span></span>
<span><span class="va">random</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"log_lambda"</span><span class="op">]</span></span>
<span><span class="va">obj_dbbmi</span> <span class="op">&lt;-</span> <span class="fu">MakeADFun</span><span class="op">(</span><span class="va">nll_dbbmi</span>, <span class="va">par</span>, random <span class="op">=</span> <span class="va">random</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">opt_dbbmi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">obj_dbbmi</span><span class="op">$</span><span class="va">par</span>, <span class="va">obj_dbbmi</span><span class="op">$</span><span class="va">fn</span>, <span class="va">obj_dbbmi</span><span class="op">$</span><span class="va">gr</span><span class="op">)</span></span></code></pre></div>
<p>We can have access to all <code><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT()</a></code>ed quantities and
their standard deviation using <code>sdreport()</code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sdr</span> <span class="op">&lt;-</span> <span class="fu">sdreport</span><span class="op">(</span><span class="va">obj_dbbmi</span>, ignore.parm.uncertainty <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">sdr</span>, <span class="st">"Est"</span>, report <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">par_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">sdr</span>, <span class="st">"Std"</span>, report <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>This way, we can easily plot the estimated smooth functions with
confidence intervals and the conditional distribution of BMI given
age.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">age</span> <span class="op">&lt;-</span> <span class="va">dbbmi</span><span class="op">$</span><span class="va">age</span></span>
<span><span class="va">ord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting estimated effects</span></span>
<span><span class="va">oldpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="va">par</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, bty <span class="op">=</span> <span class="st">"n"</span>, xlab <span class="op">=</span> <span class="st">"Age"</span>, ylab <span class="op">=</span> <span class="st">"Mu"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html" class="external-link">polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">par_sd</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2</span><span class="op">*</span><span class="va">par_sd</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"#00000020"</span>, border <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="va">par</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, bty <span class="op">=</span> <span class="st">"n"</span>, xlab <span class="op">=</span> <span class="st">"Age"</span>, ylab <span class="op">=</span> <span class="st">"Sigma"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html" class="external-link">polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">par_sd</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2</span><span class="op">*</span><span class="va">par_sd</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"#00000020"</span>, border <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="va">par</span><span class="op">$</span><span class="va">nu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, bty <span class="op">=</span> <span class="st">"n"</span>, xlab <span class="op">=</span> <span class="st">"Age"</span>, ylab <span class="op">=</span> <span class="st">"Nu"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html" class="external-link">polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">nu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">par_sd</span><span class="op">$</span><span class="va">nu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">nu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2</span><span class="op">*</span><span class="va">par_sd</span><span class="op">$</span><span class="va">nu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"#00000020"</span>, border <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Examples_files/figure-html/effects_plot-1.png" class="r-plt" alt="" width="700"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plotting conditional distribution</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dbbmi</span><span class="op">$</span><span class="va">age</span>, <span class="va">dbbmi</span><span class="op">$</span><span class="va">bmi</span>, pch <span class="op">=</span> <span class="fl">16</span>, col <span class="op">=</span> <span class="st">"#00000020"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Age"</span>, ylab <span class="op">=</span> <span class="st">"BMI"</span>, bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="va">par</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"deepskyblue"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute quantiles (point estimates)</span></span>
<span><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">par</span>, <span class="va">as.numeric</span><span class="op">)</span></span>
<span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">ps</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.005</span> <span class="co"># avoid 0 and 1</span></span>
<span><span class="va">ps</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.995</span> <span class="co"># avoid 0 and 1</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">ps</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcpe.html">qbcpe</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">par</span><span class="op">$</span><span class="va">mu</span>, <span class="va">par</span><span class="op">$</span><span class="va">sigma</span>, <span class="va">par</span><span class="op">$</span><span class="va">nu</span>, <span class="va">par</span><span class="op">$</span><span class="va">tau</span><span class="op">)</span> <span class="co"># quantiles</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, <span class="va">q</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"deepskyblue"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, lwd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"deepskyblue"</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Mean"</span>, <span class="st">"Quantiles"</span><span class="op">)</span>, bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Examples_files/figure-html/cond_dist-1.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level2">
<h2 id="example-4-zero-inflation">Example 4: Zero inflation<a class="anchor" aria-label="anchor" href="#example-4-zero-inflation"></a>
</h2>
<p>In this example, we look at the <code>aep</code> data set, containing
data on the number of inappropriate days spent in the hospital and the
length of a stay for patients admitted to a hospital in Barcelona. These
data have been analysed by Gange et al. (1996). They fitted a binomial
logistic regression model as well as a beta-binomial regression model,
concluding that the beta-binomial model produced a better fit. Due to
the large number of zeros in the data, we will here also fit a
zero-inflated binomial model and compare the results.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.gamlss.com/" class="external-link">gamlss.data</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">aep</span><span class="op">)</span></span>
<span><span class="co">#&gt;   los noinap     loglos sex ward year age y.noinap y.failures</span></span>
<span><span class="co">#&gt; 1  15      0  0.4054651   2    2   88   0        0         15</span></span>
<span><span class="co">#&gt; 2  42     20  1.4350845   2    1   88  18       20         22</span></span>
<span><span class="co">#&gt; 3   8      6 -0.2231436   1    1   88  19        6          2</span></span>
<span><span class="co">#&gt; 4   9      6 -0.1053605   1    2   88  23        6          3</span></span>
<span><span class="co">#&gt; 5   7      0 -0.3566749   1    2   88   2        0          7</span></span>
<span><span class="co">#&gt; 6  10      2  0.0000000   2    2   88  -8        2          8</span></span></code></pre></div>
<p>We start by fitting the 2 binomial models. We only define one
likelihood function and fix the zero probability to 0 for the binomial
model.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Defininig the model matrix for the model reported in Gange et al. (1996)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">ward</span> <span class="op">+</span> <span class="va">loglos</span> <span class="op">*</span> <span class="va">year</span>, data <span class="op">=</span> <span class="va">aep</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># (zero-inflated) binomial likelihood</span></span>
<span><span class="va">nll_aep</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">getAll</a></span><span class="op">(</span><span class="va">par</span>, <span class="va">dat</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">OBS</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>; <span class="va">size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">OBS</a></span><span class="op">(</span><span class="va">size</span><span class="op">)</span></span>
<span>  <span class="va">prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span> <span class="co"># linear predictor and link</span></span>
<span>  <span class="va">zeroprob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">logit_zeroprob</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">zeroprob</span><span class="op">)</span></span>
<span>  <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/zibinom.html">dzibinom</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">size</span>, <span class="va">prob</span>, <span class="va">zeroprob</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Initial parameters</span></span>
<span><span class="va">beta_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta_init</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta_init</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">aep</span><span class="op">$</span><span class="va">y</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>  size <span class="op">=</span> <span class="va">aep</span><span class="op">$</span><span class="va">los</span>,</span>
<span>  X <span class="op">=</span> <span class="va">X</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fitting the binomial model (zeroprob fixed at 0)</span></span>
<span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>logit_zeroprob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="co"># fixing at initial value</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">logit_zeroprob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">qlogis</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span> <span class="co"># set to zero</span></span>
<span><span class="va">obj_aep1</span> <span class="op">&lt;-</span> <span class="fu">MakeADFun</span><span class="op">(</span><span class="va">nll_aep</span>, <span class="va">par</span>, silent <span class="op">=</span> <span class="cn">TRUE</span>, map <span class="op">=</span> <span class="va">map</span><span class="op">)</span></span>
<span><span class="va">opt_aep1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">obj_aep1</span><span class="op">$</span><span class="va">par</span>, <span class="va">obj_aep1</span><span class="op">$</span><span class="va">fn</span>, <span class="va">obj_aep1</span><span class="op">$</span><span class="va">gr</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fitting the zero-inflated binomial model, no parameter restrictions</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">logit_zeroprob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">qlogis</a></span><span class="op">(</span><span class="fl">1e-2</span><span class="op">)</span> <span class="co"># more sensible initial value</span></span>
<span><span class="va">obj_aep2</span> <span class="op">&lt;-</span> <span class="fu">MakeADFun</span><span class="op">(</span><span class="va">nll_aep</span>, <span class="va">par</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">opt_aep2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">obj_aep2</span><span class="op">$</span><span class="va">par</span>, <span class="va">obj_aep2</span><span class="op">$</span><span class="va">fn</span>, <span class="va">obj_aep2</span><span class="op">$</span><span class="va">gr</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in nlminb(obj_aep2$par, obj_aep2$fn, obj_aep2$gr): NA/NaN function</span></span>
<span><span class="co">#&gt; evaluation</span></span>
<span></span>
<span><span class="co"># Reporting</span></span>
<span><span class="va">sdr_aep1</span> <span class="op">&lt;-</span> <span class="fu">sdreport</span><span class="op">(</span><span class="va">obj_aep1</span><span class="op">)</span></span>
<span><span class="va">sdr_aep2</span> <span class="op">&lt;-</span> <span class="fu">sdreport</span><span class="op">(</span><span class="va">obj_aep2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">sdr_aep1</span>, <span class="st">"Est"</span><span class="op">)</span><span class="op">$</span><span class="va">beta</span></span>
<span><span class="va">beta2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">sdr_aep2</span>, <span class="st">"Est"</span><span class="op">)</span><span class="op">$</span><span class="va">beta</span></span>
<span><span class="op">(</span><span class="va">zeroprob2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">sdr_aep2</span>, <span class="st">"Est"</span>, report <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">zeroprob</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.4294577</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">beta1</span>, <span class="va">beta2</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;       (Intercept)   age  ward2  ward3 loglos year90 loglos:year90</span></span>
<span><span class="co">#&gt; beta1      -1.006 0.006 -0.468 -0.615  0.518  0.168        -0.204</span></span>
<span><span class="co">#&gt; beta2       0.058 0.009 -0.622 -0.873  0.235 -0.294        -0.087</span></span></code></pre></div>
<p>We find that accounting for the zero-inflation somewhat changes the
estimated coefficients. Now we also fit the beta-binomial model. In this
model, the shape parameters are modelled as <span class="math inline">p_i / \theta_i</span> and <span class="math inline">(1-p_i) / \theta_i</span>, where <span class="math inline">p_i</span> is the covariate-dependent probability
for observation <span class="math inline">i</span> and <span class="math inline">\theta_i</span> is a parameter controlling the
overdispersion. The parameter <span class="math inline">\theta_i</span>
is modelled as a function of year only, exactly as in Gange et
al. (1996).</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Beta-binomial likelihood</span></span>
<span><span class="va">nll_aep2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">getAll</a></span><span class="op">(</span><span class="va">par</span>, <span class="va">dat</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">OBS</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>; <span class="va">size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">OBS</a></span><span class="op">(</span><span class="va">size</span><span class="op">)</span></span>
<span>  <span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">X_theta</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta_theta</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="co"># overdispersion parameter</span></span>
<span>  <span class="va">prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span> <span class="co"># linear predictor and link</span></span>
<span>  <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/betabinom.html">dbetabinom</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">size</span>, <span class="va">prob</span> <span class="op">/</span> <span class="va">theta</span>, <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">prob</span><span class="op">)</span> <span class="op">/</span> <span class="va">theta</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Design matrices</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">ward</span> <span class="op">+</span> <span class="va">loglos</span> <span class="op">+</span> <span class="va">year</span>, data <span class="op">=</span> <span class="va">aep</span><span class="op">)</span></span>
<span><span class="va">X_theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">year</span>, data <span class="op">=</span> <span class="va">aep</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Initial parameters</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">beta_theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta_theta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X_theta</span><span class="op">)</span></span>
<span></span>
<span><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span>, beta_theta <span class="op">=</span> <span class="va">beta_theta</span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">aep</span><span class="op">$</span><span class="va">y</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>  size <span class="op">=</span> <span class="va">aep</span><span class="op">$</span><span class="va">los</span>,</span>
<span>  X <span class="op">=</span> <span class="va">X</span>, </span>
<span>  X_theta <span class="op">=</span> <span class="va">X_theta</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">obj_aep3</span> <span class="op">&lt;-</span> <span class="fu">MakeADFun</span><span class="op">(</span><span class="va">nll_aep2</span>, <span class="va">par</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">opt_aep3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">obj_aep3</span><span class="op">$</span><span class="va">par</span>, <span class="va">obj_aep3</span><span class="op">$</span><span class="va">fn</span>, <span class="va">obj_aep3</span><span class="op">$</span><span class="va">gr</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sdr_aep3</span> <span class="op">&lt;-</span> <span class="fu">sdreport</span><span class="op">(</span><span class="va">obj_aep3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">sdr_aep3</span>, <span class="st">"Est"</span><span class="op">)</span><span class="op">$</span><span class="va">beta</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">beta3</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; (Intercept)       ward2       ward3      loglos      year90 </span></span>
<span><span class="co">#&gt;      -1.126      -0.320      -0.606       0.537       0.295</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example-5-copulas">Example 5: Copulas<a class="anchor" aria-label="anchor" href="#example-5-copulas"></a>
</h2>
<p>For this example, we are modelling the <code>faithful</code> data
set. It contains measurements of the waiting time between eruptions and
the duration of the eruption for the Old Faithful geyser in Yellowstone
National Park, Wyoming, USA. We will fit a mixture of two bivariate
distributions, where each component has normal marginal distributions
and a Clayton copula to model the dependence between the two
variables.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">faithful</span><span class="op">)</span></span></code></pre></div>
<p>Specifying the mixture likelihood using <code><a href="../reference/dcopula.html">dcopula()</a></code> and
<code><a href="../reference/cclayton.html">cclayton()</a></code> for the components is straightforward, it’s just
imporant to not confuse mixture components and dimensions.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nll_copula</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">getAll</a></span><span class="op">(</span><span class="va">par</span>, <span class="va">faithful</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">REPORT</a></span><span class="op">(</span><span class="va">mu1</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">REPORT</a></span><span class="op">(</span><span class="va">mu2</span><span class="op">)</span></span>
<span>  <span class="va">sigma1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_sigma1</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">REPORT</a></span><span class="op">(</span><span class="va">sigma1</span><span class="op">)</span> <span class="co"># marginal sds component 1</span></span>
<span>  <span class="va">sigma2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_sigma2</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">REPORT</a></span><span class="op">(</span><span class="va">sigma2</span><span class="op">)</span> <span class="co"># marginal sds component 2</span></span>
<span>  <span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_theta</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">REPORT</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="co"># dependence parameters</span></span>
<span>  <span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_alpha</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">REPORT</a></span><span class="op">(</span><span class="va">alpha</span><span class="op">)</span> <span class="co"># mixture weights</span></span>
<span>  <span class="co"># Marginal densities</span></span>
<span>  <span class="co"># Margin 1: Waiting</span></span>
<span>  <span class="va">d1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">waiting</span>, <span class="va">mu1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sigma1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, <span class="co"># Component 1</span></span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">waiting</span>, <span class="va">mu2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sigma2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="co"># Component 2</span></span>
<span>  <span class="co"># Margin 2: Eruptions</span></span>
<span>  <span class="va">d2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">eruptions</span>, <span class="va">mu1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">sigma1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, <span class="co"># Component 1</span></span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">eruptions</span>, <span class="va">mu2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">sigma2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="co"># Component 2</span></span>
<span>  <span class="co"># Marginal CDFs</span></span>
<span>  <span class="co"># Margin 1: Waiting</span></span>
<span>  <span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">waiting</span>, <span class="va">mu1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sigma1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="co"># Component 1</span></span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">waiting</span>, <span class="va">mu2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sigma2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co"># Component 2</span></span>
<span>  <span class="co"># Margin 2: Eruptions</span></span>
<span>  <span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">eruptions</span>, <span class="va">mu1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">sigma1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="co"># component 1</span></span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">eruptions</span>, <span class="va">mu2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">sigma2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co"># component 2</span></span>
<span>  </span>
<span>  <span class="co"># Computing mixture likelihood:</span></span>
<span>  <span class="va">ll1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dcopula.html">dcopula</a></span><span class="op">(</span><span class="va">d1</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">d2</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">p1</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">p2</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="../reference/cclayton.html">cclayton</a></span><span class="op">(</span><span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="co"># f1(x,y)</span></span>
<span>  <span class="va">ll2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dcopula.html">dcopula</a></span><span class="op">(</span><span class="va">d1</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">d2</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">p1</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">p2</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="fu"><a href="../reference/cclayton.html">cclayton</a></span><span class="op">(</span><span class="va">theta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="co"># f2(x,y)</span></span>
<span>  <span class="co"># alpha * f1(x,y) + (1-alpha) * f2(x,y) on log scale for each obervation</span></span>
<span>  <span class="va">ll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/Distributions.html" class="external-link">logspace_add</a></span><span class="op">(</span><span class="va">log_alpha</span> <span class="op">+</span> <span class="va">ll1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="op">-</span><span class="va">alpha</span><span class="op">)</span> <span class="op">+</span> <span class="va">ll2</span><span class="op">)</span> </span>
<span>  <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ll</span><span class="op">)</span> <span class="co"># returning negative sum</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We fit the model as usual, now using reporting to easily extract the
estimated parameters on their natural scale:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Initial parameters</span></span>
<span><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  mu1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">55</span>, <span class="fl">2</span><span class="op">)</span>, mu2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">80</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  log_sigma1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, log_sigma2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  log_theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  log_alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">obj_copula</span> <span class="op">&lt;-</span> <span class="fu">MakeADFun</span><span class="op">(</span><span class="va">nll_copula</span>, <span class="va">par</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">opt_copula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">obj_copula</span><span class="op">$</span><span class="va">par</span>, <span class="va">obj_copula</span><span class="op">$</span><span class="va">fn</span>, <span class="va">obj_copula</span><span class="op">$</span><span class="va">gr</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod_copula</span> <span class="op">&lt;-</span> <span class="va">obj_copula</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract transformed parameters</span></span>
<span><span class="va">mu1</span>    <span class="op">&lt;-</span> <span class="va">mod_copula</span><span class="op">$</span><span class="va">mu1</span></span>
<span><span class="va">mu2</span>    <span class="op">&lt;-</span> <span class="va">mod_copula</span><span class="op">$</span><span class="va">mu2</span></span>
<span><span class="va">sigma1</span> <span class="op">&lt;-</span> <span class="va">mod_copula</span><span class="op">$</span><span class="va">sigma1</span></span>
<span><span class="va">sigma2</span> <span class="op">&lt;-</span> <span class="va">mod_copula</span><span class="op">$</span><span class="va">sigma2</span></span>
<span><span class="va">theta</span>  <span class="op">&lt;-</span> <span class="va">mod_copula</span><span class="op">$</span><span class="va">theta</span></span>
<span><span class="va">alpha</span>  <span class="op">&lt;-</span> <span class="va">mod_copula</span><span class="op">$</span><span class="va">alpha</span></span></code></pre></div>
<p>We can plot the result:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Scatterplot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">faithful</span><span class="op">$</span><span class="va">waiting</span>, <span class="va">faithful</span><span class="op">$</span><span class="va">eruptions</span>, pch <span class="op">=</span> <span class="fl">20</span>, bty <span class="op">=</span> <span class="st">"n"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Waiting time"</span>, ylab <span class="op">=</span> <span class="st">"Eruption time"</span>, col <span class="op">=</span> <span class="st">"#00000070"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Grid for evaluation</span></span>
<span><span class="va">xseq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">faithful</span><span class="op">$</span><span class="va">waiting</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">faithful</span><span class="op">$</span><span class="va">waiting</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">80</span><span class="op">)</span></span>
<span><span class="va">yseq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">faithful</span><span class="op">$</span><span class="va">eruptions</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">faithful</span><span class="op">$</span><span class="va">eruptions</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">80</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Evaluate component densities on grid</span></span>
<span><span class="va">f1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">xseq</span>, <span class="va">yseq</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">d1c1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">mu1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sigma1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">d2c1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">mu1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">sigma1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">p1c1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">mu1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sigma1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">p2c1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">mu1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">sigma1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/dcopula.html">dcopula</a></span><span class="op">(</span><span class="va">d1c1</span>, <span class="va">d2c1</span>, <span class="va">p1c1</span>, <span class="va">p2c1</span>, <span class="fu"><a href="../reference/cclayton.html">cclayton</a></span><span class="op">(</span><span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">f2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">xseq</span>, <span class="va">yseq</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">d1c2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">mu2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sigma2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">d2c2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">mu2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">sigma2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">p1c2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">mu2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sigma2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">p2c2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">mu2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">sigma2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/dcopula.html">dcopula</a></span><span class="op">(</span><span class="va">d1c2</span>, <span class="va">d2c2</span>, <span class="va">p1c2</span>, <span class="va">p2c2</span>, <span class="fu"><a href="../reference/cclayton.html">cclayton</a></span><span class="op">(</span><span class="va">theta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add contours</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/contour.html" class="external-link">contour</a></span><span class="op">(</span><span class="va">xseq</span>, <span class="va">yseq</span>, <span class="va">alpha</span> <span class="op">*</span> <span class="va">f1</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, nlevels <span class="op">=</span> <span class="fl">8</span>,</span>
<span>        drawlabels <span class="op">=</span> <span class="cn">FALSE</span>, col <span class="op">=</span> <span class="st">"orange"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/contour.html" class="external-link">contour</a></span><span class="op">(</span><span class="va">xseq</span>, <span class="va">yseq</span>, <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">alpha</span><span class="op">)</span> <span class="op">*</span> <span class="va">f2</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, nlevels <span class="op">=</span> <span class="fl">8</span>,</span>
<span>        drawlabels <span class="op">=</span> <span class="cn">FALSE</span>, col <span class="op">=</span> <span class="st">"deepskyblue"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Examples_files/figure-html/copula%20results-1.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level2">
<h2 id="example-6-multivariate-stochastic-volatility">Example 6: Multivariate stochastic volatility<a class="anchor" aria-label="anchor" href="#example-6-multivariate-stochastic-volatility"></a>
</h2>
<p>This example reproduces one of the <code>TMB</code> examples. It fits
a multivariate stochastic volatility model to financial returns data. In
the example given <a href="https://github.com/kaskr/RTMB/blob/master/tmb_examples/sdv_multi.R" class="external-link">here</a>,
the response distribution is a multivariate Gaussian, with the marginal
variance for each of the three time series being time-varying and
modelled based on a latent volatility process. We generalise the example
to a multivariate t distribution, which typically results in a better
fit to financial returns data, due to the heavier tails.</p>
<p>We get the data from</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/kaskr/RTMB/master/tmb_examples/sdv_multi_data.R"</span><span class="op">)</span></span></code></pre></div>
<p>The code below is basically the same as in the original example, but
uses a multivariate t distribution (<code><a href="../reference/mvt.html">dmvt()</a></code>) in the data
likelihood. Note that the <code>Cov</code> matrix is now not actually
the covariance matrix anymore, but only proportional to it.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Multivatiate SV model from Table 5 of Skaug and Yu "A flexible and automated likelihood based </span></span>
<span><span class="co"># framework for inference in stochastic volatility models." Computational Statistics &amp; Data Analysis 76 (2014): 642-654.</span></span>
<span></span>
<span><span class="co">## Parameter initial guess</span></span>
<span><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  logit_phi  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">qlogis</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.97</span>,<span class="va">p</span><span class="op">)</span><span class="op">)</span>,       <span class="co"># See eqn (12) in Skaug and Yu (2014)</span></span>
<span>  log_sigma  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="va">p</span><span class="op">)</span><span class="op">)</span>,           <span class="co">#       ---------||---------</span></span>
<span>  mu_y       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>,<span class="va">p</span><span class="op">)</span>,               <span class="co">#       ---------||---------</span></span>
<span>  off_diag_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">p</span><span class="op">)</span>,                  <span class="co">#       ---------||---------</span></span>
<span>  h          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>,nrow<span class="op">=</span><span class="va">n</span>,ncol<span class="op">=</span><span class="va">p</span><span class="op">)</span>,   <span class="co">#       ---------||---------</span></span>
<span>  log_df     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>                    <span class="co"># this allows for heavier tails</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Negative joint likelihood (nll) of data and parameters</span></span>
<span><span class="va">nll_svt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">getAll</a></span><span class="op">(</span><span class="va">par</span><span class="op">)</span></span>
<span>  <span class="co"># Optionally mark the observation object</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">OBS</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Parameters on natural scale</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_sigma</span><span class="op">)</span></span>
<span>  <span class="va">phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">logit_phi</span><span class="op">)</span></span>
<span>  <span class="va">sigma_init</span> <span class="op">&lt;-</span> <span class="va">sigma</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">phi</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_df</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="fl">0</span>  <span class="co"># Start collecting contributions</span></span>
<span>  </span>
<span>  <span class="co"># Prior on state variable (h)</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">h</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>, <span class="fl">0</span>, <span class="va">sigma_init</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>   <span class="co"># Start in stationary distribution</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">p</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">h</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">phi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">*</span><span class="va">h</span><span class="op">[</span><span class="op">-</span><span class="va">n</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">sigma</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>  <span class="co"># AR(1) process for each dimension</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Parameterizes correlation matrix of X in terms of Cholesky factor</span></span>
<span>  <span class="va">L</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span>  <span class="va">L</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">lower.tri</a></span><span class="op">(</span><span class="va">L</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">off_diag_x</span>   </span>
<span>  <span class="va">row_norms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">L</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">row</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">row</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">L</span> <span class="op">&lt;-</span> <span class="va">L</span> <span class="op">/</span> <span class="va">row_norms</span></span>
<span>  <span class="va">R</span> <span class="op">&lt;-</span> <span class="va">L</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">L</span><span class="op">)</span>  <span class="co"># Correlation matrix of X (guarantied positive definite)</span></span>
<span>  </span>
<span>  <span class="co"># Likelihood of data y given h</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">sigma_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">0.5</span> <span class="op">*</span> <span class="op">(</span><span class="va">mu_y</span> <span class="op">+</span> <span class="va">h</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co"># variance depending on state</span></span>
<span>    <span class="va">Cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">sigma_y</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">R</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">sigma_y</span><span class="op">)</span></span>
<span>    <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/mvt.html">dmvt</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>, <span class="fl">0</span>, <span class="va">Cov</span>, <span class="va">df</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">nll</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">obj_svt</span> <span class="op">&lt;-</span> <span class="fu">MakeADFun</span><span class="op">(</span><span class="va">nll_svt</span>, <span class="va">par</span>, random<span class="op">=</span><span class="st">"h"</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">opt_svt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">obj_svt</span><span class="op">$</span><span class="va">par</span>, <span class="va">obj_svt</span><span class="op">$</span><span class="va">fn</span>, <span class="va">obj_svt</span><span class="op">$</span><span class="va">gr</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;  13.959   0.031  13.991</span></span>
<span><span class="va">rep</span> <span class="op">&lt;-</span> <span class="fu">sdreport</span><span class="op">(</span><span class="va">obj_svt</span><span class="op">)</span></span>
<span><span class="va">rep</span></span>
<span><span class="co">#&gt; sdreport(.) result</span></span>
<span><span class="co">#&gt;              Estimate Std. Error</span></span>
<span><span class="co">#&gt; logit_phi   3.6269542 0.49413568</span></span>
<span><span class="co">#&gt; logit_phi   3.1290137 0.38240912</span></span>
<span><span class="co">#&gt; logit_phi   4.7269255 0.80777552</span></span>
<span><span class="co">#&gt; log_sigma  -1.9420595 0.21824559</span></span>
<span><span class="co">#&gt; log_sigma  -2.0048373 0.17178092</span></span>
<span><span class="co">#&gt; log_sigma  -2.4015626 0.34312782</span></span>
<span><span class="co">#&gt; mu_y       -1.1388822 0.18663075</span></span>
<span><span class="co">#&gt; mu_y       -1.0938327 0.11876150</span></span>
<span><span class="co">#&gt; mu_y       -1.5630285 0.31299779</span></span>
<span><span class="co">#&gt; off_diag_x -1.3641053 0.06465394</span></span>
<span><span class="co">#&gt; off_diag_x -1.1315426 0.06265752</span></span>
<span><span class="co">#&gt; off_diag_x  0.7446955 0.04688460</span></span>
<span><span class="co">#&gt; log_df      1.9632807 0.13715707</span></span>
<span><span class="co">#&gt; Maximum gradient component: 0.0009298736</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jan-Ole Koslik.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
